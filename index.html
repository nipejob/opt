
<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⏳ Optælling</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 560px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 16px;
            font-size: 24px;
        }

        .categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 14px;
        }

        .category {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 12px 8px; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;
            transition: transform 0.1s; user-select: none; min-height: 75px;
        }
        .category:active { transform: scale(0.98); }

        .category-name { font-size: 13px; text-align: center; margin-bottom: 5px; }
        .category-count { font-size: 20px; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 20px; }

        .slik { background: #dc2626; }
        .org { background: #f97316; }
        .mastro { background: #4b5563; }
        .chokolade { background: #78350f; }
        .quick50 { background: #065f46; }
        .aktier { background: #6b21a8; }
        .andet { background: #1e40af; }

        .view-toggle { display: flex; gap: 10px; margin-bottom: 10px; }
        .view-toggle button {
            flex: 1; padding: 12px; border: none; background: #f3f4f6; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .view-toggle button.active { background: #667eea; color: white; }

        .actions {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;
        }
        .actions .full { grid-column: 1 / -1; }

        .btn {
            padding: 12px; border: 2px solid transparent; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all .2s;
        }
        .btn-primary { background: #10b981; color: white; }
        .btn-primary:hover { filter: brightness(0.95); }
        .btn-secondary { background: white; color: #374151; border-color: #9ca3af; }
        .btn-secondary:hover { background: #f3f4f6; }
        .btn-danger { background: white; color: #dc2626; border-color: #dc2626; }
        .btn-danger:hover { background: #dc2626; color: white; }
        .btn-ghost { background: #f3f4f6; color: #374151; }

        .stats-view {
            background: #f9fafb; border-radius: 12px; padding: 15px; margin-bottom: 12px; display: none;
        }
        .year-section { margin-bottom: 20px; }
        .year-section:last-child { margin-bottom: 0; }
        .year-header {
            font-weight: 700; color: #1f2937; margin-bottom: 12px; font-size: 18px;
            padding-bottom: 8px; border-bottom: 3px solid #667eea;
        }
        .month-section { margin-bottom: 12px; background: white; padding: 12px; border-radius: 8px; }
        .month-header {
            font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 15px;
            padding-bottom: 6px; border-bottom: 2px solid #e5e7eb;
        }
        .category-item {
            padding: 8px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6;
        }
        .category-item:last-child { border-bottom: none; }
        .category-item-name { font-weight: 600; color: #4b5563; font-size: 14px; }
        .category-item-count { font-weight: 700; font-size: 18px; color: #1f2937; }
        .entry-dates { font-size: 12px; color: #6b7280; margin-top: 4px; }

        .qr-section {
            text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px; margin-top: 10px;
        }
        #qrcode { display: inline-block; padding: 10px; background: white; border-radius: 8px; }
        .qr-info { margin-top: 10px; font-size: 12px; color: #6b7280; }

        /* Tilgængelighed: fokus-stil */
        .category:focus { outline: 3px solid rgba(102,126,234,0.65); outline-offset: 2px; }
    </style>
</head>
<body>
<div class="container">
    <h1>⏳ Optælling</h1>

    <div class="categories" id="categories"></div>

    <div class="view-toggle">
        <button id="totalBtn" class="active">Total</button>
        <button id="monthBtn">Pr. Måned</button>
        <button id="yearBtn">Pr. År</button>
    </div>

    <div class="actions">
        <button id="downloadCsvBtn" class="btn btn-primary">Download års-CSV</button>
        <button id="downloadDataBtn" class="btn btn-secondary">Download data (til dags dato)</button>
        <button id="undoBtn" class="btn btn-ghost full">Fortryd sidste</button>
    </div>

    <div id="statsView" class="stats-view"></div>

    <div class="qr-section">
        <div id="qrcode"></div>
        <div class="qr-info">Scan QR-koden for at gemme/dele data (indbygget i URL)</div>
        <button class="btn btn-danger full" id="deleteTodayBtn">Slet Dagens Optælling</button>
    </div>
</div>

<script>
/* ---------- Konfiguration ---------- */
const categories = [
    { name: 'Slik',       class: 'slik',      id: 'S'  },
    { name: 'Org',        class: 'org',       id: 'O'  },
    { name: 'Mastro',     class: 'mastro',    id: 'M'  },
    { name: 'Chokolade',  class: 'chokolade', id: 'C'  },
    { name: 'Quick50',    class: 'quick50',   id: 'Q'  },
    { name: 'Aktier',     class: 'aktier',    id: 'A'  },
    { name: 'Andet',      class: 'andet',     id: 'N'  },
    { name: 'Andet 2',    class: 'andet',     id: 'N2' },
    { name: 'Andet 3',    class: 'andet',     id: 'N3' }
];

// Data gemmes som { categoryId: 'S', timestamp: ISO }
let entries = [];
let currentView = 'total';

const LS_KEY = 'optaelling_entries_v2'; // v2 da vi gemmer categoryId
let qrTimer = null;

/* ---------- Hjælpere ---------- */
function getBaseURL() {
    return window.location.href.split('?')[0].split('#')[0];
}
function getCategoryById(id) {
    return categories.find(c => c.id === id);
}
function getCounts() {
    const counts = Object.fromEntries(categories.map(c => [c.id, 0]));
    entries.forEach(e => { if (counts[e.categoryId] !== undefined) counts[e.categoryId]++; });
    return counts;
}
function isSameLocalDay(isoStr, date = new Date()) {
    const d = new Date(isoStr);
    return d.getFullYear() === date.getFullYear() &&
           d.getMonth()    === date.getMonth() &&
           d.getDate()     === date.getDate();
}
function endOfTodayLocal() {
    const d = new Date();
    d.setHours(23, 59, 59, 999);
    return d;
}
function formatDate(isoStr) {
    return new Date(isoStr).toLocaleDateString('da-DK', { day: '2-digit', month: '2-digit' });
}
function getMonthKey(dateStr) {
    const d = new Date(dateStr);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
}
function getYearKey(dateStr) {
    const d = new Date(dateStr);
    return `${d.getFullYear()}`;
}
function getMonthName(monthKey) {
    const [year, month] = monthKey.split('-').map(Number);
    const d = new Date(year, month - 1, 1);
    return d.toLocaleDateString('da-DK', { month: 'long', year: 'numeric' }); // fx "januar 2026"
}
function formatDateFile(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
}

/* ---------- URL/QR encode/decode ---------- */
function loadFromURL() {
    const params = new URLSearchParams(window.location.search);
    const data = params.get('d');
    if (!data) return false;
    try {
        const decoded = JSON.parse(atob(data));
        entries = decoded.map(e => ({
            categoryId: e.c,
            timestamp: new Date(e.t).toISOString()
        }));
        return true;
    } catch {
        entries = [];
        return false;
    }
}
function getDataURL() {
    const compact = entries.map(e => ({
        c: e.categoryId,
        t: new Date(e.timestamp).getTime()
    }));
    const encoded = btoa(JSON.stringify(compact));
    return getBaseURL() + '?d=' + encoded + (location.hash ? location.hash : '');
}
function updateQR() {
    const qrDiv = document.getElementById('qrcode');
    qrDiv.innerHTML = '';
    new QRCode(qrDiv, { text: getDataURL(), width: 200, height: 200 });
}
function scheduleQRUpdate() {
    clearTimeout(qrTimer);
    qrTimer = setTimeout(updateQR, 200);
}

/* ---------- LocalStorage ---------- */
function saveLocal() {
    try { localStorage.setItem(LS_KEY, JSON.stringify(entries)); } catch {}
}
function loadLocal() {
    try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) entries = JSON.parse(raw);
    } catch { entries = []; }
}

/* ---------- Dataaggregering ---------- */
function getMonthlyData() {
    const monthly = {};
    entries.forEach(entry => {
        const monthKey = getMonthKey(entry.timestamp);
        if (!monthly[monthKey]) {
            monthly[monthKey] = Object.fromEntries(categories.map(c => [c.id, []]));
        }
        if (monthly[monthKey][entry.categoryId]) {
            monthly[monthKey][entry.categoryId].push(entry.timestamp);
        }
    });
    return monthly;
}
function getYearlyData() {
    const yearly = {};
    entries.forEach(entry => {
